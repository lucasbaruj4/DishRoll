# Changelog

## 2026-02-14
- Refined recipe-detail typography hierarchy so section titles (`Macros`, `Ingredients`, `Instructions`) are larger/heavier than body lines, and reduced body boldness for clearer title-vs-content distinction while preserving readability.
- Updated recipe detail hero/title section to an unboxed layout with larger typography for name, description, and prep time, and increased instruction-step typography to match the larger ingredient list style.
- Updated recipe detail `Macros` and `Ingredients` presentation: removed boxed section wrappers, switched macros to a larger 2x2 square-card layout (matching the change-macros visual pattern), and increased ingredient text size in a plain numbered list format.
- Simplified recipe detail instruction rendering to plain numbered text lines (removed boxed instruction cards and section panel styling) for a cleaner reading flow while cooking.
- Updated recipe detail header back button to chevron-only (`headerBackButtonDisplayMode: 'minimal'`) so the top-left control no longer shows the previous route label text.
- Added a new authenticated recipe-detail flow at `app/recipe/[id].tsx` that loads full saved recipe content (description, macros, ingredients, instructions) from Supabase via user-scoped lookup (`getRecipeById`) and displays a floating `Cook with AI` CTA.
- Wired navigation into recipe detail from both Save events and saved-list browsing: right-swiping a persisted card in `Generate` now opens that recipe, and `Saved` cards now include an `Open recipe` action.
- Added a placeholder `Cook with AI` route at `app/recipe/[id]/cook.tsx`, including signed-in ownership validation before showing content so future chat work remains recipe-scoped and access-safe.
- Refocused `Generate` on card swiping by removing the inline out-of-sync warning block from the main layout, expanding the active swipe card to fill more of the stage, and introducing a one-time out-of-sync modal with two explicit choices: `Generate new recipes` or `Keep current deck`.
- Improved out-of-sync deck recovery UX on `Generate`: added inline warning-card actions (`Change macros`, `Sync deck`) so users can re-sync without scrolling to bottom CTAs, and removed the forced 420px deck min-height so action controls remain reachable on smaller screens.
- Fixed Generate swipe freeze cases by adding guarded swipe finalization (animation fallback timeout + responder-terminate cleanup), preventing cards from getting stuck half-swiped with interaction locked.
- Upgraded the preloaded "next" card behind the active swipe card to use the full final card design and added drag-linked forward motion (scale, translate, opacity) so it visibly advances as the top card is swiped away.
- Ran `context-agents-hi` context sync again: reviewed `AGENTS.md` and all current `docs/*.md`, and logged Agent 582 scope ownership in `docs/COLLABORATION.md`.
- Fixed the `Adjust macros` keyboard-open spacing regression by disabling `ScrollView` automatic keyboard inset adjustment in the modal (`automaticallyAdjustKeyboardInsets={false}`), avoiding double inset with `KeyboardAvoidingView`.
- Removed fixed-height sizing from the `Adjust macros` sheet container and stopped forcing `ScrollView` to fill available space, so the modal now wraps content and eliminates the remaining large blank area below `Available ingredients`.
- Removed remaining empty space below `Available ingredients` in the `Adjust macros` modal by dropping `ScrollView` content `flexGrow` and using a minimal fixed bottom inset (`12`) instead of footer-height-based padding.
- Reverted `Generate` swipe handling from worklets (`react-native-gesture-handler` `GestureDetector` + Reanimated shared values) back to React Native `Animated + PanResponder` to fix runtime crashes caused by a JS/native worklets mismatch in the current client environment.
- Improved app responsiveness in two hot paths: moved `Generate` swipe handling to `react-native-gesture-handler` + Reanimated shared values/worklets (UI-thread drag updates), and replaced Inventory's per-item availability save loop with a single batched `user_ingredients` upsert.
- Hardened `Adjust macros` sheet sizing on `Generate` by replacing percentage-based sheet heights with a numeric height computed from `useWindowDimensions`, addressing cases where the modal resolved to footer-only content.
- Fixed `Adjust macros` modal collapse on `Generate`: the sheet now uses a full-height `KeyboardAvoidingView` container plus explicit sheet height so macro fields remain visible instead of collapsing to a footer-only `Done` row on some devices.
- Ran `context-agents-hi` project-context sync again: reviewed `AGENTS.md` plus all current `docs/*.md`, and logged Agent 731 ACTIVE/DONE scope ownership in `docs/COLLABORATION.md`.
- Finalized `Adjust macros` sheet layout with a sheet-only `KeyboardAvoidingView` (`position` on iOS), enabled iOS scroll keyboard inset adjustment, and normalized footer bottom padding to a fixed value to remove residual dead space while keeping the persistent `Done` action visible.
- Added `docs/COLLABORATION.md` and logged Agent 349 ACTIVE/DONE scope tracking for `context-agents-hi` project-context synchronization.
- Rebuilt `Adjust macros` sheet keyboard behavior to a single-layout model: wrapped modal content in `KeyboardAvoidingView`, removed forced sheet min-height, kept `Done` as a fixed footer, and added footer-height-aware scroll bottom padding so inputs remain visible while the quick-exit button stays pinned across screen sizes.
- Simplified `Adjust macros` keyboard handling by removing iOS `InputAccessoryView`, modal keyboard-lift listeners, dynamic sheet bottom offsets, and automatic scroll-view inset adjustment; the sheet now uses fixed layout/padding to avoid accessory-reserved gap behavior.
- Reworked `Adjust macros` keyboard avoidance to use measured modal viewport overlap (`keyboard screenY` vs modal height) instead of raw keyboard height offsets, preventing iOS double-lift gaps on devices where the modal already resizes with the keyboard.
- Fixed `Adjust macros` keyboard spacing by replacing hardcoded iOS sheet lift offsets with safe-area-aware keyboard insets and reducing footer bottom padding while typing, removing the visible gap above the number pad.
- Tuned iOS `Adjust macros` keyboard lift offset downward so the sheet stays closer to the keyboard and avoids oversized vertical gaps while editing numeric fields.
- Removed residual empty space under the `Adjust macros` footer by switching the sheet body to flex layout (`ScrollView` with `flex: 1` + `flexGrow`) so taller sheet height is filled by content area instead of leaving a bottom gap.
- Fixed `Adjust macros` bottom-sheet dead-space gaps by refining keyboard inset handling (prefer keyboard height, apply a smaller iOS offset, and reset inset when the sheet closes) while preserving the taller sheet layout.
- Increased `Adjust macros` bottom-sheet vertical capacity (higher max-height + new min-height) with responsive sizing so macro tiles and helper copy do not feel clipped on smaller devices.
- Made the `Adjust macros` 2x2 grid responsive across device sizes by scaling tile spacing/height/value typography with screen width and switching to a single-column layout on very narrow screens.
- Updated the `Adjust macros` sheet form to a compact 2x2 square-card grid (protein, carbs, fats, prep time) for better screen-space use and easier one-handed editing.
- Simplified `Generate` action hierarchy by removing the duplicate in-card `Generate new deck` CTA shown at deck completion; deck states now rely on a single primary bottom generate/regenerate/sync action.
- Moved `Change macros` from the top header into the bottom action area as a reachable secondary action above the primary generate CTA.
- Improved `Generate` swipe responsiveness by making card progression optimistic: advancing to the next card immediately on release and moving Supabase swipe logging to a non-blocking post-interaction sync path.
- Reduced swipe-release latency with native-driven off-screen/reset animations and added velocity-based flick detection so quick left/right gestures commit without requiring long drag distance.

## 2026-02-13
- Replaced bottom-tab selector glyphs with explicit Ionicons for all tabs (`Generate`, `Inventory`, `Saved`, `Profile`) using filled/outline active states for cleaner navigation visuals.
- Updated Step 3 (cooking level) finish flow to wait until questionnaire completion state is readable before navigating to tabs, preventing brief duplicate return-to-step animations.
- Improved cooking-level slider touch tracking to use measured track screen coordinates (`pageX`) so grabbing the knob no longer jumps toward the start position.
- Fixed transition-edge white flash by setting root stack `contentStyle` background to dark and aligning app-level appearance/splash background to dark defaults.
- Converted Step 2 (allergies/dislikes) CTA into a floating action bar anchored above the bottom safe area, matching the Step 1 floating action treatment.
- Fixed signup/create-account transition direction by switching auth screen replace animations (`Log In`, `Sign Up`) to forward-style `push`, so moving into questionnaire no longer feels like reverse/back navigation.
- Changed questionnaire screen replace animations to forward-direction (`animationTypeForReplace: 'push'`) so onboarding step-to-step transitions no longer look like back navigation.
- Updated Step 2 (allergies/dislikes) CTA copy to be visible by default with dynamic text: `No allergies or dislikes` when empty, and `X allergy/dislikes saved` after selections.
- Updated onboarding Step 1 (ingredients) to use a conditional floating `Continue` action bar that appears only after selecting at least 3 ingredients, matching the Inventory save-bar interaction model.
- Switched onboarding/auth entry and questionnaire forward transitions to `replace` (`onboarding` -> `signup/login/ingredients`, ingredients -> allergies, allergies -> cooking level) for more consistent stack navigation behavior.
- Set auth `TextInput` keyboard appearance to dark on `Sign Up` and `Log In` so iOS keyboard theme matches the dark UI.
- Added explicit header-left chevron buttons on `Log In` and `Sign Up` that route back to onboarding, ensuring a visible iOS-style back control even when no prior stack entry exists.
- Ensured auth-screen back affordance stays label-less while preserving iOS chevron styling.
- Updated `Log In` header back button to chevron-only (no label) and removed the in-screen `Back to intro` link.
- Switched auth cross-links between `Log In` and `Sign Up` to `replace` navigation and enabled `animationTypeForReplace: 'pop'` on both screens for consistent stack-direction transitions.
- Updated signup header back button to chevron-only (`headerBackButtonDisplayMode: 'minimal'`) so the `Onboarding` label is not shown.
- Implemented `Saved` tab data integration with Supabase `recipes` (`is_saved = true`): saved recipes now load on focus/reload, support pull-to-refresh, and can be deleted from the app.
- Added per-user local persistence for last-used Generate macro/time targets so app reload restores the most recent quick-generation inputs without introducing a global default.
- Added per-user local active-deck resume state (recipe IDs, swipe index, ingredient signature) and DB-backed hydration on app load so persisted decks continue where users left off after reload.
- Added recipe lookup helper (`getRecipesByIds`) for ordered deck restoration from Supabase based on locally persisted deck IDs.
- Refactored `Generate` tab into a persistent swipe-deck-first experience with macro editing in a non-blocking bottom sheet instead of a page-level control stack.
- Added ingredient-sync awareness for generated decks (`Not synced recipes`) so users can keep swiping older decks while seeing when inventory has drifted.
- Improved swipe-deck card presentation with stronger visual hierarchy (hero area, progress indicator, macro chips) while preserving existing save/skip behavior.
- Reworked macro editing ergonomics: replaced +/- stepping with direct numeric entry, deferred clamping/normalization until blur/Done/Generate, and added iOS keyboard accessory `Done`.
- Fixed macro sheet keyboard UX across device sizes by using keyboard frame-driven dynamic insets so footer/actions avoid keyboard overlap on iOS and Android.
- Simplified Generate interaction model to remove duplicate execution actions: macro sheet is now editor-only with `Done`, and deck generation/regeneration/sync is triggered by a single main-screen CTA.
- Removed explicit `Skip`/`Save` action buttons from Generate to align with swipe-first interaction; swiping is now the only accept/reject action.
- Added a one-time swipe tutorial overlay (animated left/right hint + required "I understand swipe controls" checkbox + `Got it`) persisted locally so it only appears until acknowledged.

## 2026-02-12
- Hardened edge generation request handling with ingredient input length caps and OpenAI upstream timeout protection (`openai_timeout` -> HTTP 504).
- Replaced SDK edge invoke path for recipe generation with explicit HTTPS call to `https://<project-ref>.functions.supabase.co/generate-recipes` using bearer session token + `apikey` to avoid persistent `invalid JWT` gateway ambiguity.
- Updated function auth propagation to use `supabase.functions.setAuth(accessToken)` before invoke, preventing publishable-key authorization from being treated as JWT by edge gateway.
- Added automatic auth-session refresh + single retry for recipe generation when edge function returns `invalid JWT`.
- Fixed recipe-generation edge invoke auth propagation by explicitly attaching the current Supabase access token to function requests.
- Fixed Inventory ingredient tile layout regression (names rendering vertically due nested width constraints) by removing extra wrapper sizing.
- Changed Inventory availability edits to staged changes with an animated floating bottom action bar and explicit `Save changes` commit button.
- Made Edge Function model configurable via server secret: `OPENAI_MODEL` (defaults to `gpt-4o-mini`) so testing can switch to cheaper models without code changes.
- Expanded `docs/OPENAI_EDGE_FUNCTION_SETUP.md` with explicit OpenAI setup details: model used, prompt used, and fast/low-cost dev testing guidance.
- Hardened `generate-recipes` Edge Function with authenticated-user enforcement, per-user rolling rate limiting (12 requests / 15 minutes), and request usage logging.
- Added migration `supabase/migrations/0007_2026_02_12_recipe_generation_logs.sql` for `recipe_generation_logs` (indexes + RLS policy) used by rate limiting and observability.
- Updated `docs/OPENAI_EDGE_FUNCTION_SETUP.md` with migration step (`supabase db push`) plus secure deploy flow.
- Moved OpenAI recipe generation off the client into Supabase Edge Function `generate-recipes` (`supabase/functions/generate-recipes/index.ts`) so API keys are server-only.
- Switched app generation calls to `supabase.functions.invoke('generate-recipes')` with local-draft fallback if the function is unavailable.
- Removed `EXPO_PUBLIC_OPENAI_API_KEY` from client env templates (`.env.local`, `.env.example`) and documented secure setup in `docs/OPENAI_EDGE_FUNCTION_SETUP.md`.
- Added recipe generation infrastructure with robust local fallback behavior for both generation and persistence failures.
- Removed the `Quick Generate` top panel from `Generate` while keeping the four macro/prep cards and `Generate Swipe Deck` action as requested.
- Reordered bottom tabs to the requested sequence: `Generate`, `Inventory`, `Saved`, `Profile`.
- Set `Generate` as the default tab landing route (tab layout, root index redirect, and post-auth/post-questionnaire redirects).
- Revamped the `Generate` screen visual design with card-based hierarchy and improved macro input layout.
- Migrated generate ingredient sourcing from legacy `ingredients` table to onboarding-backed `user_ingredients` + `ingredient_catalog`.
- Rebuilt `Inventory` UI to match onboarding ingredient selection: searchable quick-pick tiles with identical tile component and styling direction.
- Added `useUserIngredients` hook for availability state management on `user_ingredients`.
- Updated dev RLS checks to validate `user_ingredients` instead of deprecated `ingredients`.
- Applied visual polish to `Saved` and `Profile` tab screens for consistent styling.

## 2026-02-11
- Continuing frontend refinement on onboarding and auth-related UX details.
- Backend feature work is queued next after onboarding polish is finalized.
- Fixed onboarding carousel card clipping and edge overflow behavior.
- Added animated onboarding background circles and scroll-linked pagination dots.
- Tuned card spacing and indicator sizing for cleaner slide transitions.
- Started planning the post-signup `initial_questionaire` flow for new users.
- Defined three-step questionnaire scope: available ingredients, allergies/disliked foods, and cooking level.
- Beginning implementation with the first questionnaire screen focused on ingredient selection UI.
- Added `initial_questionaire` route pipeline and wired signup redirect to the ingredient step.
- Implemented ingredient questionnaire UI with searchable quick-pick tiles backed by `ingredient_catalog`.
- Added persistence from ingredient questionnaire selections into `user_ingredients`.
- Added profile-based questionnaire gating so logged-in users are redirected to onboarding until setup is complete.
- Added dietary restriction source-of-truth schema: `dietary_restriction_catalog` + `user_dietary_restrictions` with RLS and seed options.
- Added fully implemented allergies/dislikes questionnaire step with searchable catalog UI and persistence to `user_dietary_restrictions`.
- Refactored questionnaire persistence into shared service utilities and renamed step state from `level` to `cooking_level` for clarity.
- Added normalized `cooking_level_catalog` (5-point scale) and implemented step 3 with a fixed-stop slider UI that saves selected level to user profile.
- Fixed onboarding resume routing so incomplete users return to their saved questionnaire step instead of always restarting at ingredients.
- Polished cooking-level slider interaction by locking page scroll during drag and fixing knob edge alignment at both track extremes.
- Added explicit Back buttons to all `initial_questionaire` steps (ingredients, allergies/dislikes, cooking level).
- Synced questionnaire progress state when navigating backward so resume returns to the correct previous step.
- Confirmed multi-select questionnaire persistence uses delete-then-insert on every Continue for both `user_ingredients` (questionnaire source) and `user_dietary_restrictions`.
- Tightened ingredient prefill in the questionnaire to only read rows with `source = 'questionnaire'`.
- Replaced in-screen Back buttons with iOS-style header back controls for all questionnaire steps.
- Fixed unreliable back navigation by routing header back actions directly to deterministic previous-step routes.
- Adjusted questionnaire navigation to use deterministic `router.replace(...)` transitions for both forward and backward step moves.
- Removed back-step profile rewrites that could incorrectly downgrade resume position from `cooking_level` to earlier steps.
- Hid header back controls while a save request is in progress to prevent duplicate navigation actions.
- Fixed root auth gate regression that forced users back to the persisted questionnaire step, which blocked intentional in-flow back navigation.
- Updated questionnaire step navigation to use stack semantics (`push` forward, `back` backward) for native linear transition direction.
- Added one-time initial questionnaire route sync on app bootstrap so reopen respects the persisted DB step without overriding in-flow back navigation.
- Tightened auth gating for incomplete users so only `initial_questionaire/*` routes are allowed, preventing onboarding/login detours from breaking questionnaire back-stack expectations.
- Updated questionnaire back flow to deterministic linear behavior: step 3 -> step 2 -> step 1 -> onboarding (no loop back to step 3).
- Adjusted incomplete-user auth gating to allow staying on onboarding and only resume questionnaire when re-entering, using persisted DB step sync.
- Updated onboarding CTA behavior for signed-in incomplete users to show `Resume setup` and route into questionnaire resume path.
- Hid onboarding header (`Welcome`) to remove redundant back navigation from the intro screen.
- Switched questionnaire back handlers to `dismissTo(...)` and configured `animationTypeForReplace: 'pop'` for questionnaire + onboarding routes to keep back-like iOS transitions on replace fallbacks.
- Disabled iOS swipe-back gestures on questionnaire screens so navigation advances/returns only through explicit controls.
- Fixed post-setup routing race in root auth gate by refreshing questionnaire progress on route changes and immediately redirecting completed users to `/(tabs)/inventory`.
- Applied dark-mode styling to tab navigator chrome: dark header and dark bottom tab bar with updated active/inactive tint colors.
- Removed the `Onboarding` text label from the signup screen back button so only the back chevron is shown.
- Updated sign-out behavior to clear local auth session state/storage immediately, preventing stale-session limbo after server-side user deletion.

## 2026-02-09
- Scaffolded Expo Router structure with auth and tab layouts.
- Added Supabase client setup with auth persistence.
- Implemented auth flow (login/signup) with protected routing.
- Added onboarding and kitchen selection screens.
- Built ingredient inventory CRUD + availability toggle.
- Added dev-only RLS sanity check.
- Created initial Supabase schema migration in `supabase/migrations/0001_init.sql`.
- Updated build plan progress tracking.
- Applied dark mode styling across key screens.
